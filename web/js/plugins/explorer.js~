(function($){
    window.$m = $.extend( true , window.$m !== undefined ? window.$m : {} , {
        explorer: {
            elt: $('#explorer'),
            nav: $('#explorer-tree-nav'),
            init: function() {
            
                /*$m.events.bind( 'scroll' , '#explorer' , function ( event ) {
                    
                    $('.folder.active .scroll-detector',$m.explorer.elt).each(function(i,o){
                        o = $(o);
                        var position = o.position();
                        
                        if ( position.top < window.screen.height * 2 ) {
                            var $folder = $('.folder.active',$m.explorer.elt);
                            var p = $folder.attr('data-path');
                            var request = {
                                c:'file',a:'search',
                                path: p, offset: $folder.find('.image, .album').length,
                            };
                            
                            if ( $('#search').val() ) request['search'] = $('#search').val();
                            
                            console.log( request );
                            
                            $m.api.get(request,function(json){
                                if ( json.length == 0 ) {
                                    $('.folder.active .scroll-detector',$m.explorer.elt).remove();
                                } else {
                                    for ( var type in json ) {
                                        if ( $m.view && $m.view[type] && typeof($m.view[type].load) == 'function' ) {
                                            $m.view[type].load( p , json[type] );
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                });*/

                $m.events.bind( 'click' , '#explorer-tree-nav' , function ( event ) {
                    var $target = $( event.target );
                    var path = $target.attr('data-path');
                    var $folder = $('.folder[data-path="'+path+'"]')
                    if ( $folder.length ) {
                        $folder.addClass('active').siblings().removeClass('active');
                    }
                });
            
            },
            path: function ( path ) {
                if ( path === undefined ) return $m.state.path;
            
                var folders = path.split( '/' ); var c = folders.length;
                console.log( folders );
                
                //$m.explorer.elt.css('width', ( 100 / $m.config.columns * (c-1) ) + '%' )
                
                $('#explorer-tree-nav').empty();
                
                var i = folders.length-1;
                var f = [
                    function(){
                        if ( i > 0 ) {
                            // Current folder absolute path :
                            var p = folders.slice(0,i+1).join('/');
                            
                            // Update the navigation bar :
                            $m.explorer.prependNav( folders[i] , p , c-i <= 2 );
                            
                            if ( true || i == folders.length-1 ) {
                                // Add folder to the explorer :
                                $m.explorer.addFolder( folders[i] , p , 2 );
                                console.log( p );
                                $m.api.get({c:'file',a:'list',path: p},function(json){
                                    $m.log(json);
                                    
                                    for ( var type in json ) {
                                        if ( $m.view && $m.view[type] && typeof($m.view[type].load) == 'function' ) {
                                            $m.view[type].load( p , json[type] , true );
                                        }
                                    }
                                    
                                    i--; f[0]();
                                });
                            } else {
                                i--; f[0]();
                            }
                            
                        } else f[1]();
                    },
                    function(){
                        $m.explorer.elt.find('.folder:nth-child(3)').addClass('active');
                    }
                ]; f[0]();
            },
            prependNav: function ( name , path , visible ) {
                if ( path != '' ) {
                    //$m.explorer.nav.find('li:last-child').prepend(' <span class="divider">/</span>');
                    $m.explorer.nav.prepend('<li'+( visible ? ' class="visible"' : '' )+'><span class="divider">/</span><a data-path="'+path+'" href="javascript:void(0);">'+name+'</a></li>');
                } else {
                    $m.explorer.nav.prepend('<li class="visible"><a data-path="'+path+'" href="javascript:void(0);"><i class="icon-home"></i></a></li>');
                }
            },
            addFolder: function ( name , path , c ) {
                
                if ( $('.folder[data-path="'+path+'"]').length == 0 ) {
                
                    var $column = $('<div class="column folder" id="'+path.replace(/[^0-9a-z]/gi,'-')+'" data-path="'+path+'" style="width: '+(100/(c-1))+'%;"></div>');
                    var $content = $('<div class="content"></div>');
                    
                    //$content.append( '<div class="name">' + name + '</div>' );
                    
                    $column.append('<div class="scroll-detector" style="" onClick="$(\'#left\').trigger(\'scroll.media\');">Load more...</div>');
                    
                    $m.explorer.elt.prepend( $column.prepend( $content ) );
                    
                    $m.events.bind( 'scroll' , '#'+path.replace(/[^0-9a-z]/gi,'-') , $m.explorer.events.scroll );
                    
                }
            },
            
            
            
            events: {
                scroll: function ( event ) {
                
                    $('.folder.active .scroll-detector',$m.explorer.elt).each(function(i,o){
                        o = $(o);
                        var position = o.position();
                        
                        if ( position.top < window.screen.height * 2 ) {
                            var $folder = $('.folder.active',$m.explorer.elt);
                            var p = $folder.attr('data-path');
                            var request = {
                                c:'file',a:'search',
                                path: p, offset: $folder.find('.image, .album').length,
                            };
                            
                            if ( $('#search').val() ) request['search'] = $('#search').val();
                            
                            $m.api.get(request,function(json){
                                if ( json.length == 0 ) {
                                    $('.folder.active .scroll-detector',$m.explorer.elt).remove();
                                } else {
                                    for ( var type in json ) {
                                        if ( $m.view && $m.view[type] && typeof($m.view[type].load) == 'function' ) {
                                            $m.view[type].load( p , json[type] );
                                        }
                                    }
                                }
                            });
                        }
                    });
                }
            }
            
        },
    });
    
    $m.explorer.init();
    
})(jQuery);
